<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Record detail - Email History</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <span>Email History</span>
    <div>
      <a href="dashboard.html">Dashboard</a>
      <a href="upload.html">Upload</a>
      <a href="#" id="logoutLink">Logout</a>
    </div>
  </header>
  <div class="container detail-page">
    <a href="dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
    <h1>Record details</h1>
    <p class="detail-loading hidden" id="loading">Loading...</p>
    <p class="detail-error hidden" id="errorMsg"></p>
    <div class="detail-card hidden" id="detailCard"></div>
    <div class="detail-card last-visit-section hidden" id="lastVisitSection">
      <div class="detail-row">
        <span class="detail-label">Last Visit Date</span>
        <input type="date" id="lastVisitDate" class="detail-value">
      </div>
      <div class="detail-row show-comm-row hidden" id="showCommRow">
        <span class="detail-label"></span>
        <button type="button" class="btn" id="showCommunicationBtn">Show communication</button>
      </div>
      <div class="visit-dates-table-wrap hidden" id="visitDatesTableWrap">
        <h3 class="visit-dates-heading">Visit dates with forms</h3>
        <table class="visit-dates-table">
          <thead><tr><th>Visit Date</th><th>Form</th></tr></thead>
          <tbody id="visitDatesTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="js/auth.js"></script>
  <script>
    (function () {
      if (!auth.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }
      document.getElementById('logoutLink').addEventListener('click', function (e) {
        e.preventDefault();
        auth.removeToken();
        auth.removeRegion();
        window.location.href = 'login.html';
      });
      var params = new URLSearchParams(window.location.search);
      var id = params.get('id');
      var loadingEl = document.getElementById('loading');
      var errorMsg = document.getElementById('errorMsg');
      var detailCard = document.getElementById('detailCard');
      if (!id) {
        loadingEl.classList.add('hidden');
        errorMsg.textContent = 'No record ID provided.';
        errorMsg.classList.remove('hidden');
        return;
      }
      loadingEl.classList.remove('hidden');
      fetch(auth.getApiUrl('/records/' + encodeURIComponent(id)), {
        headers: auth.getAuthHeaders()
      })
        .then(function (res) {
          if (res.status === 401) {
            auth.removeToken();
            window.location.href = 'login.html';
            return;
          }
          return res.json();
        })
        .then(function (data) {
          loadingEl.classList.add('hidden');
          if (!data) return;
          if (data.error) {
            errorMsg.textContent = data.error;
            errorMsg.classList.remove('hidden');
            return;
          }
          var html = '';
          if (data.sourceFile) {
            html += '<div class="detail-row"><span class="detail-label">Source file</span><span class="detail-value">' + escapeHtml(data.sourceFile) + '</span></div>';
          }
          if (data.rowIndex) {
            html += '<div class="detail-row"><span class="detail-label">Row index</span><span class="detail-value">' + escapeHtml(String(data.rowIndex)) + '</span></div>';
          }
          var d = data.data || {};
          Object.keys(d).forEach(function (key) {
            html += '<div class="detail-row"><span class="detail-label">' + escapeHtml(key) + '</span><span class="detail-value">' + escapeHtml(String(d[key] != null ? d[key] : '')) + '</span></div>';
          });
          detailCard.innerHTML = html;
          detailCard.classList.remove('hidden');
          var lastVisitSection = document.getElementById('lastVisitSection');
          var lastVisitInput = document.getElementById('lastVisitDate');
          var showCommRow = document.getElementById('showCommRow');
          var visitDatesTableWrap = document.getElementById('visitDatesTableWrap');
          var visitDatesTableBody = document.getElementById('visitDatesTableBody');
          lastVisitSection.classList.remove('hidden');
          var visitDate = data.lastVisitDate;
          if (visitDate) {
            var d2 = new Date(visitDate);
            var y = d2.getFullYear(), m = d2.getMonth() + 1, day = d2.getDate();
            lastVisitInput.value = y + '-' + (m < 10 ? '0' + m : m) + '-' + (day < 10 ? '0' + day : day);
            showCommRow.classList.remove('hidden');
          } else {
            lastVisitInput.value = '';
          }
          function toggleShowCommButton() {
            if (lastVisitInput.value) showCommRow.classList.remove('hidden');
            else showCommRow.classList.add('hidden');
          }
          lastVisitInput.addEventListener('input', toggleShowCommButton);
          lastVisitInput.addEventListener('change', function () {
            var val = lastVisitInput.value || null;
            toggleShowCommButton();
            fetch(auth.getApiUrl('/records/' + encodeURIComponent(id)), {
              method: 'PATCH',
              headers: auth.getAuthHeaders(),
              body: JSON.stringify({ lastVisitDate: val })
            }).catch(function () {}).then(function () { loadVisitDatesList(); });
          });
          document.getElementById('showCommunicationBtn').addEventListener('click', function () {
            var vd = lastVisitInput.value;
            if (!vd) return;
            var w = window.open('communication.html?recordId=' + encodeURIComponent(id) + '&visitDate=' + encodeURIComponent(vd), 'communication', 'width=700,height=700,scrollbars=yes,resizable=yes');
            if (w) w.focus();
          });
          function loadVisitDatesList() {
            fetch(auth.getApiUrl('/records/' + encodeURIComponent(id) + '/communications'), { headers: auth.getAuthHeaders() })
              .then(function (r) { return r.status === 401 ? null : r.json(); })
              .then(function (list) {
                if (!Array.isArray(list) || list.length === 0) {
                  visitDatesTableWrap.classList.add('hidden');
                  return;
                }
                visitDatesTableBody.innerHTML = list.map(function (c) {
                  var d = c.visitDate || '';
                  return '<tr><td>' + escapeHtml(d) + '</td><td><a href="communication.html?recordId=' + encodeURIComponent(id) + '&visitDate=' + encodeURIComponent(d) + '" target="_blank" rel="noopener">Open form</a></td></tr>';
                }).join('');
                visitDatesTableWrap.classList.remove('hidden');
              })
              .catch(function () { visitDatesTableWrap.classList.add('hidden'); });
          }
          loadVisitDatesList();
          window.refreshVisitDatesList = loadVisitDatesList;
        })
        .catch(function () {
          loadingEl.classList.add('hidden');
          errorMsg.textContent = 'Failed to load record.';
          errorMsg.classList.remove('hidden');
        });
      function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
    })();
  </script>
</body>
</html>
